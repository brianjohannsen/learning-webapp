<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Course - Learning App</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-DZ6AFxxVa1JJ7XOvFHagiJYagFM3kG9AmZUCr+v++uWfmxs9yL4wqhNJJTymehLd" crossorigin="anonymous">
</head>
<body class="bg-light">
  <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom shadow-sm">
    <div class="container-fluid">
      <a class="navbar-brand fw-bold" href="dashboard.html">Learning App</a>
      <div class="d-flex ms-auto align-items-center">
        <img id="navProfilePic" src="" alt="Profile" class="rounded-circle me-2" style="width:32px;height:32px;object-fit:cover; display:none;">
        <span id="welcomeName" class="navbar-text me-3"></span>
        <a href="dashboard.html" class="btn btn-outline-secondary btn-sm me-2">Dashboard</a>
        <button id="logoutBtn" class="btn btn-outline-danger btn-sm">Logout</button>
      </div>
    </div>
  </nav>
  <div class="container mt-4">
    <h2 id="courseTitle"></h2>
    <p id="courseDescription" class="text-muted"></p>
    <div id="courseContent" class="mb-4"></div>
    <div class="mb-4">
      <div class="progress" style="height: 20px;">
        <div class="progress-bar" id="progressBar" role="progressbar" style="width:0%" aria-valuemin="0" aria-valuemax="100">0%</div>
      </div>
      <button id="increaseProgressBtn" class="btn btn-primary mt-2">Mark Progress +10%</button>
    </div>
    <a href="dashboard.html" class="btn btn-outline-secondary">Back to Dashboard</a>
  </div>
<script>
  const userId = localStorage.getItem('userId');
  const welcomeNameEl = document.getElementById('welcomeName');
  const navPicEl = document.getElementById('navProfilePic');
  if (!userId) {
    window.location.href = 'index.html';
  }
  // Logout functionality
  document.getElementById('logoutBtn').addEventListener('click', () => {
    localStorage.removeItem('userId');
    localStorage.removeItem('userName');
    localStorage.removeItem('profilePicture');
    window.location.href = 'index.html';
  });
  // Update nav from localStorage or fetch
  function updateNav() {
    const name = localStorage.getItem('userName');
    if (name) welcomeNameEl.textContent = `Hello, ${name}!`;
    const pic = localStorage.getItem('profilePicture');
    if (pic) {
      navPicEl.src = pic;
      navPicEl.style.display = 'block';
    } else {
      navPicEl.style.display = 'none';
    }
  }
  updateNav();
  // Get course id from query string
  const params = new URLSearchParams(window.location.search);
  const courseId = parseInt(params.get('id'), 10);
  if (!courseId) {
    document.getElementById('courseTitle').textContent = 'Course Not Found';
  } else {
    loadCourse();
  }
  async function loadCourse() {
    try {
      const [courseRes, userCoursesRes] = await Promise.all([
        fetch(`/api/courses/${courseId}`),
        fetch(`/api/user/${userId}/courses`)
      ]);
      const course = await courseRes.json();
      const userCourses = await userCoursesRes.json();
      if (!courseRes.ok) throw new Error(course.error || 'Course not found');
      document.getElementById('courseTitle').textContent = course.title;
      document.getElementById('courseDescription').textContent = course.description || '';
      document.getElementById('courseContent').textContent = course.content || '';
      const uc = userCourses.find(c => c.id === course.id) || { progress: 0 };
      updateProgressBar(uc.progress);
      document.getElementById('increaseProgressBtn').onclick = () => markProgress(uc.progress);
    } catch (err) {
      console.error(err);
    }
  }
  function updateProgressBar(progress) {
    const bar = document.getElementById('progressBar');
    bar.style.width = `${progress}%`;
    bar.textContent = `${progress}%`;
  }
  async function markProgress(current) {
    const newProgress = Math.min(100, current + 10);
    try {
      const res = await fetch(`/api/user/${userId}/course/${courseId}/progress`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ progress: newProgress })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Failed to update progress');
      updateProgressBar(newProgress);
    } catch (err) {
      console.error(err);
    }
  }
</script>
</body>
</html>