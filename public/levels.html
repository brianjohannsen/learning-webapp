<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Levels - Learning App</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <nav class="navbar">
    <a href="dashboard.html" class="brand">Learning App</a>
    <div class="nav-actions">
      <img id="navProfilePic" src="" alt="Profile" class="profile-pic" style="display:none;">
      <span id="welcomeName"></span>
      <a href="profile.html" class="btn btn-secondary">Profile</a>
      <a href="admin.html" id="adminLink" class="btn btn-secondary" style="display:none;">Admin</a>
      <button class="btn btn-danger" id="logoutBtn">Logout</button>
    </div>
  </nav>
  <div class="container">
    <h2 id="courseTitle" style="margin-bottom:1rem;">Levels</h2>
    <div id="levelsContainer" class="grid grid-1"></div>
  </div>
  <script>
    const userId = localStorage.getItem('userId');
    if (!userId) {
      window.location.href = 'index.html';
    }
    // Logout button
    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('userId');
      localStorage.removeItem('userName');
      localStorage.removeItem('profilePicture');
      window.location.href = 'index.html';
    });
    // Update nav information
    function updateNav() {
      const name = localStorage.getItem('userName');
      const welcomeNameEl = document.getElementById('welcomeName');
      const navPicEl = document.getElementById('navProfilePic');
      if (name) welcomeNameEl.textContent = `Hello, ${name}!`;
      const pic = localStorage.getItem('profilePicture');
      if (pic) {
        navPicEl.src = pic;
        navPicEl.style.display = 'block';
      } else {
        navPicEl.src = 'default_profile.png';
        navPicEl.style.display = 'block';
      }
      const adminLinkEl = document.getElementById('adminLink');
      if (parseInt(userId) === 1 && adminLinkEl) {
        adminLinkEl.style.display = 'inline-block';
      }
    }
    updateNav();
    const params = new URLSearchParams(window.location.search);
    const courseId = parseInt(params.get('id'), 10);
    if (!courseId) {
      document.getElementById('courseTitle').textContent = 'Course Not Found';
    }
    // Load levels and render
    async function loadLevels() {
      try {
        // fetch course title
        const courseRes = await fetch(`/api/courses/${courseId}`);
        const course = await courseRes.json();
        if (course && course.title) {
          document.getElementById('courseTitle').textContent = `${course.title} - Levels`;
        }
        const res = await fetch(`/api/courses/${courseId}/levels?userId=${userId}`);
        const levels = await res.json();
        const container = document.getElementById('levelsContainer');
        container.innerHTML = '';
        // Sort by id ascending
        levels.sort((a, b) => a.id - b.id);
        levels.forEach((lvl, index) => {
          const status = lvl.status || 'not_started';
          let statusColor = '#6c757d';
          if (status === 'in_progress') statusColor = '#17a2b8';
          if (status === 'submitted') statusColor = '#ffc107';
          if (status === 'approved') statusColor = '#28a745';
          if (status === 'rejected') statusColor = '#dc3545';
          // Determine if level is locked (require previous level approval)
          let locked = false;
          if (index > 0) {
            const prev = levels[index - 1];
            if (prev.status !== 'approved') {
              locked = true;
            }
          }
          const card = document.createElement('div');
          card.innerHTML = `
            <div class="card" style="padding:1rem; margin-bottom:1rem;">
              <h3 style="margin-bottom:0.5rem;">${lvl.title}</h3>
              <p style="margin-bottom:0.5rem;">${lvl.description || ''}</p>
              <span style="display:inline-block; padding:0.25rem 0.5rem; border-radius:12px; background-color:${statusColor}; color:#fff; font-size:0.8rem; text-transform:capitalize;">${status.replace('_', ' ')}</span>
              <div style="margin-top:0.75rem;">
                <a href="level.html?id=${lvl.id}" class="btn btn-primary" ${locked ? 'style="pointer-events:none; opacity:0.5;"' : ''}>Open Level</a>
              </div>
            </div>
          `;
          container.appendChild(card);
        });
      } catch (err) {
        console.error(err);
      }
    }
    loadLevels();
  </script>
</body>
</html>