<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Learning App</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <nav class="navbar">
    <a href="dashboard.html" class="brand">Learning App</a>
    <div class="nav-actions">
      <img id="navProfilePic" src="" alt="Profile" class="profile-pic" style="display:none;">
      <span id="welcomeName"></span>
      <a href="dashboard.html" class="btn btn-secondary">Dashboard</a>
      <button id="logoutBtn" class="btn btn-danger">Logout</button>
    </div>
  </nav>
  <div class="container">
    <h2>Admin Dashboard</h2>
    <div id="accessDenied" class="alert alert-danger d-none">Access denied. You do not have permission to view this page.</div>
    <div id="adminContent" style="display:none;">
      <section style="margin-top:2rem;">
        <h3>Add New Course</h3>
        <form id="addCourseForm" class="grid grid-2" style="gap:1rem;">
          <div>
            <label for="courseTitle">Title</label>
            <input type="text" id="courseTitle" required>
          </div>
          <div>
            <label for="courseDescription">Description</label>
            <input type="text" id="courseDescription">
          </div>
          <div>
            <label for="courseImage">Image</label>
            <input type="file" id="courseImage" accept="image/*">
          </div>
          <div style="grid-column: 1 / -1;">
            <label for="courseContent">Content</label>
            <textarea id="courseContent" rows="4"></textarea>
          </div>
          <div style="grid-column: 1 / -1;">
            <button type="submit" class="btn btn-primary">Add Course</button>
          </div>
        </form>
        <div id="addCourseMsg" class="mt-2"></div>
      </section>
      <section style="margin-top:3rem;">
        <h3>All Courses</h3>
        <div id="coursesGrid" class="grid grid-3"></div>
      </section>
      <section style="margin-top:3rem;">
        <h3>All Users</h3>
        <div id="usersGrid" class="grid grid-3"></div>
      </section>
      <section style="margin-top:3rem;">
        <h3>Add New Level</h3>
        <form id="addLevelForm" class="grid grid-2" style="gap:1rem;">
          <div>
            <label for="levelCourse">Course</label>
            <select id="levelCourse" required></select>
          </div>
          <div>
            <label for="levelTitle">Title</label>
            <input type="text" id="levelTitle" required>
          </div>
          <div style="grid-column:1/-1;">
            <label for="levelDescription">Description</label>
            <textarea id="levelDescription" rows="3"></textarea>
          </div>
          <div style="grid-column:1/-1;">
            <label for="levelContent">Content</label>
            <textarea id="levelContent" rows="4"></textarea>
          </div>
          <div style="grid-column:1/-1;">
            <label for="levelMaterials">Materials (comma separated links)</label>
            <input type="text" id="levelMaterials">
          </div>
          <div style="grid-column:1/-1;">
            <label for="levelKnowledge">Knowledge (comma separated IDs)</label>
            <input type="text" id="levelKnowledge">
          </div>
          <div style="grid-column:1/-1;">
            <button type="submit" class="btn btn-primary">Add Level</button>
          </div>
        </form>
        <div id="addLevelMsg" class="mt-2"></div>
      </section>
    </div>
  </div>
  <script>
    const userId = parseInt(localStorage.getItem('userId'), 10);
    const welcomeNameEl = document.getElementById('welcomeName');
    const navPicEl = document.getElementById('navProfilePic');
    const accessDeniedEl = document.getElementById('accessDenied');
    const adminContentEl = document.getElementById('adminContent');
    if (!userId) {
      window.location.href = 'index.html';
    }
    // Logout functionality
    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('userId');
      localStorage.removeItem('userName');
      localStorage.removeItem('profilePicture');
      window.location.href = 'index.html';
    });
    // Setup nav info from storage
    function updateNav() {
      const name = localStorage.getItem('userName');
      if (name) welcomeNameEl.textContent = `Hello, ${name}!`;
      const pic = localStorage.getItem('profilePicture');
      if (pic) {
        navPicEl.src = pic;
        navPicEl.style.display = 'block';
      } else {
        // Show default profile placeholder when no picture is available
        navPicEl.src = 'default_profile.png';
        navPicEl.style.display = 'block';
      }
    }
    updateNav();
    // Only allow user with id 1 as admin (simple check)
    if (userId !== 1) {
      accessDeniedEl.classList.remove('d-none');
      adminContentEl.style.display = 'none';
    } else {
      adminContentEl.style.display = 'block';
      loadCourses();
      loadUsers();
    }
    // Load courses list and render as cards
    async function loadCourses() {
      try {
        const res = await fetch('/api/courses');
        const courses = await res.json();
        const container = document.getElementById('coursesGrid');
        container.innerHTML = '';
        courses.forEach(course => {
          const card = document.createElement('div');
          card.className = 'card';
          let imgHtml;
          if (course.image) {
            imgHtml = `<img src="${course.image}" alt="${course.title}">`;
          } else {
            // Use default course placeholder image when none provided
            imgHtml = `<img src="default_course.png" alt="${course.title}">`;
          }
          card.innerHTML = `
            <div class="course-card" style="display:flex;flex-direction:column;height:100%;">
              ${imgHtml}
              <h4 style="margin:0.5rem 0;">${course.title}</h4>
              <p style="flex-grow:1;">${course.description || ''}</p>
              <div style="margin-top:auto; display:flex; gap:0.5rem;">
                <a href="levels.html?id=${course.id}" class="btn btn-outline" style="flex:1;">Open</a>
                <a href="admin-course.html?id=${course.id}" class="btn btn-primary" style="flex:1;">Manage</a>
              </div>
            </div>
          `;
          container.appendChild(card);
        });
        // Populate course dropdown for adding levels
        const courseSelect = document.getElementById('levelCourse');
        if (courseSelect) {
          courseSelect.innerHTML = '';
          courses.forEach(course => {
            const opt = document.createElement('option');
            opt.value = course.id;
            opt.textContent = course.title;
            courseSelect.appendChild(opt);
          });
        }
      } catch (err) {
        console.error(err);
      }
    }
    // Load users list and render as cards
    async function loadUsers() {
      try {
        const res = await fetch('/api/admin/users');
        const users = await res.json();
        const container = document.getElementById('usersGrid');
        container.innerHTML = '';
        users.forEach(u => {
          const card = document.createElement('div');
          card.className = 'card user-card';
          card.innerHTML = `
            <h4 style="margin-bottom:0.5rem;">${u.name}</h4>
            <p style="margin-bottom:0.5rem;">${u.email}</p>
            <a href="admin-user.html?id=${u.id}" class="btn btn-outline">View</a>
          `;
          container.appendChild(card);
        });
      } catch (err) {
        console.error(err);
      }
    }
    // Handle add course form submission, including optional image upload
    document.getElementById('addCourseForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const title = document.getElementById('courseTitle').value.trim();
      const description = document.getElementById('courseDescription').value.trim();
      const content = document.getElementById('courseContent').value.trim();
      const imageInput = document.getElementById('courseImage');
      const msgDiv = document.getElementById('addCourseMsg');
      msgDiv.classList.remove('alert-success','alert-danger');
      function submitCourse(imageData) {
        fetch('/api/admin/courses', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title, description, content, imageData })
        }).then(async res => {
          const data = await res.json();
          return { ok: res.ok, data };
        }).then(result => {
          if (!result.ok) {
            msgDiv.textContent = result.data.error || 'Failed to add course';
            msgDiv.classList.add('alert','alert-danger');
            return;
          }
            msgDiv.textContent = 'Course added successfully';
            msgDiv.classList.add('alert','alert-success');
            // clear form
            document.getElementById('courseTitle').value = '';
            document.getElementById('courseDescription').value = '';
            document.getElementById('courseContent').value = '';
            document.getElementById('courseImage').value = '';
            loadCourses();
            loadUsers();
        }).catch(err => {
          msgDiv.textContent = err.message;
          msgDiv.classList.add('alert','alert-danger');
        });
      }
      if (imageInput && imageInput.files && imageInput.files[0]) {
        const reader = new FileReader();
        reader.onloadend = function() {
          submitCourse(reader.result);
        };
        reader.readAsDataURL(imageInput.files[0]);
      } else {
        submitCourse(null);
      }
    });

    // Handle add level form submission
    const addLevelFormEl = document.getElementById('addLevelForm');
    if (addLevelFormEl) {
      addLevelFormEl.addEventListener('submit', (e) => {
        e.preventDefault();
        const courseId = document.getElementById('levelCourse').value;
        const title = document.getElementById('levelTitle').value.trim();
        const description = document.getElementById('levelDescription').value.trim();
        const content = document.getElementById('levelContent').value.trim();
        const materialsInput = document.getElementById('levelMaterials').value.trim();
        const knowledgeInput = document.getElementById('levelKnowledge').value.trim();
        const materials = materialsInput ? materialsInput.split(',').map(s => s.trim()).filter(s => s) : [];
        const knowledgeIds = knowledgeInput ? knowledgeInput.split(',').map(s => s.trim()).filter(s => s) : [];
        const msg = document.getElementById('addLevelMsg');
        msg.classList.remove('alert','alert-success','alert-danger');
        fetch('/api/admin/levels', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ courseId, title, description, content, materials, knowledge: knowledgeIds })
        }).then(async res => {
          const data = await res.json();
          return { ok: res.ok, data };
        }).then(result => {
          if (!result.ok) {
            msg.textContent = result.data.error || 'Failed to add level';
            msg.classList.add('alert','alert-danger');
            return;
          }
          msg.textContent = 'Level added successfully';
          msg.classList.add('alert','alert-success');
          document.getElementById('levelTitle').value = '';
          document.getElementById('levelDescription').value = '';
          document.getElementById('levelContent').value = '';
          document.getElementById('levelMaterials').value = '';
          document.getElementById('levelKnowledge').value = '';
          loadCourses();
        }).catch(err => {
          msg.textContent = err.message;
          msg.classList.add('alert','alert-danger');
        });
      });
    }
  </script>
</body>
</html>