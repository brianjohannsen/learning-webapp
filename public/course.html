<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Course - Learning App</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-DZ6AFxxVa1JJ7XOvFHagiJYagFM3kG9AmZUCr+v++uWfmxs9yL4wqhNJJTymehLd" crossorigin="anonymous">
</head>
<body class="bg-light">
  <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom shadow-sm">
    <div class="container-fluid">
      <a class="navbar-brand fw-bold" href="dashboard.html">Learning App</a>
      <div class="d-flex ms-auto align-items-center">
        <img id="navProfilePic" src="" alt="Profile" class="rounded-circle me-2" style="width:32px;height:32px;object-fit:cover; display:none;">
        <span id="welcomeName" class="navbar-text me-3"></span>
        <a href="dashboard.html" class="btn btn-outline-secondary btn-sm me-2">Dashboard</a>
        <button id="logoutBtn" class="btn btn-outline-danger btn-sm">Logout</button>
      </div>
    </div>
  </nav>
  <div class="container mt-4">
    <!-- Course header -->
    <div class="row mb-4">
      <div class="col-12 col-md-8">
        <h2 id="courseTitle" class="fw-bold"></h2>
        <p id="courseDescription" class="lead text-muted"></p>
      </div>
      <div class="col-12 col-md-4 d-flex flex-column align-items-start align-items-md-end">
        <!-- Progress card -->
        <div class="card w-100">
          <div class="card-body">
            <h5 class="card-title">Progress</h5>
            <div class="progress mb-3" style="height: 20px;">
              <div class="progress-bar" id="progressBar" role="progressbar" style="width:0%" aria-valuemin="0" aria-valuemax="100">0%</div>
            </div>
            <button id="increaseProgressBtn" class="btn btn-primary w-100">Mark Progress +10%</button>
          </div>
        </div>
        <a href="dashboard.html" class="btn btn-link mt-3">&laquo; Back to Dashboard</a>
      </div>
    </div>
    <!-- Course content -->
    <div class="row">
      <div class="col-12">
        <h3>Course Content</h3>
        <div id="courseContent" class="mb-3"></div>
        <ul id="moduleList" class="list-group"></ul>
      </div>
    </div>
  </div>
<script>
  const userId = localStorage.getItem('userId');
  const welcomeNameEl = document.getElementById('welcomeName');
  const navPicEl = document.getElementById('navProfilePic');
  if (!userId) {
    window.location.href = 'index.html';
  }
  // Logout functionality
  document.getElementById('logoutBtn').addEventListener('click', () => {
    localStorage.removeItem('userId');
    localStorage.removeItem('userName');
    localStorage.removeItem('profilePicture');
    window.location.href = 'index.html';
  });
  // Update nav from localStorage or fetch
  function updateNav() {
    const name = localStorage.getItem('userName');
    if (name) welcomeNameEl.textContent = `Hello, ${name}!`;
    const pic = localStorage.getItem('profilePicture');
    if (pic) {
      navPicEl.src = pic;
      navPicEl.style.display = 'block';
    } else {
      navPicEl.style.display = 'none';
    }
  }
  updateNav();
  // Get course id from query string
  const params = new URLSearchParams(window.location.search);
  const courseId = parseInt(params.get('id'), 10);
  if (!courseId) {
    document.getElementById('courseTitle').textContent = 'Course Not Found';
  } else {
    loadCourse();
  }
  async function loadCourse() {
    try {
      const [courseRes, userCoursesRes] = await Promise.all([
        fetch(`/api/courses/${courseId}`),
        fetch(`/api/user/${userId}/courses`)
      ]);
      const course = await courseRes.json();
      const userCourses = await userCoursesRes.json();
      if (!courseRes.ok) throw new Error(course.error || 'Course not found');
      document.getElementById('courseTitle').textContent = course.title;
      document.getElementById('courseDescription').textContent = course.description || '';
      // Render course content as paragraphs and modules list
      const contentEl = document.getElementById('courseContent');
      const moduleListEl = document.getElementById('moduleList');
      contentEl.innerHTML = '';
      moduleListEl.innerHTML = '';
      if (course.content) {
        // Split content by double newline to separate intro and modules
        const parts = course.content.split(/\n\n+/);
        // First part as introduction text
        const intro = parts.shift();
        if (intro) {
          const p = document.createElement('p');
          p.textContent = intro;
          contentEl.appendChild(p);
        }
        // Remaining parts as modules
        if (parts.length > 0) {
          parts.forEach((mod, index) => {
            const li = document.createElement('li');
            li.className = 'list-group-item';
            li.innerHTML = `<strong>Module ${index + 1}:</strong> ${mod.trim()}`;
            moduleListEl.appendChild(li);
          });
        }
      }
      const uc = userCourses.find(c => c.id === course.id) || { progress: 0 };
      updateProgressBar(uc.progress);
      document.getElementById('increaseProgressBtn').onclick = () => markProgress(uc.progress);
    } catch (err) {
      console.error(err);
    }
  }
  function updateProgressBar(progress) {
    const bar = document.getElementById('progressBar');
    bar.style.width = `${progress}%`;
    bar.textContent = `${progress}%`;
  }
  async function markProgress(current) {
    const newProgress = Math.min(100, current + 10);
    try {
      const res = await fetch(`/api/user/${userId}/course/${courseId}/progress`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ progress: newProgress })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Failed to update progress');
      updateProgressBar(newProgress);
    } catch (err) {
      console.error(err);
    }
  }
</script>
</body>
</html>