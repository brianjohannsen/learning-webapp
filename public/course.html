<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Course - Learning App</title>
  <!-- Custom styles -->
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <nav class="navbar">
    <a href="dashboard.html" class="brand">Learning App</a>
    <div class="nav-actions">
      <img id="navProfilePic" src="" alt="Profile" class="profile-pic" style="display:none;">
      <span id="welcomeName"></span>
      <a href="dashboard.html" class="btn btn-secondary">Dashboard</a>
      <button id="logoutBtn" class="btn btn-danger">Logout</button>
    </div>
  </nav>
  <div class="container">
    <div class="grid grid-2" style="align-items: start; gap: 2rem; margin-top:2rem;">
      <div>
        <div id="courseImageContainer"></div>
        <h2 id="courseTitle" style="margin-bottom:0.5rem;"></h2>
        <p id="courseDescription" class="text-muted" style="margin-bottom:1rem;"></p>
        <h3>Course Content</h3>
        <div id="courseContent" class="mb-3"></div>
        <ul id="moduleList" class="list-group"></ul>
      </div>
      <div>
        <div class="card">
          <h3>Progress</h3>
          <div class="progress-container" style="margin-bottom:1rem;">
            <div class="progress-bar" id="progressBar" role="progressbar" style="width:0%">0%</div>
          </div>
          <button id="increaseProgressBtn" class="btn btn-primary" style="width:100%;">Mark Progress +10%</button>
        </div>
        <a href="dashboard.html" class="btn btn-outline" style="margin-top:1rem; display:inline-block;">&laquo; Back to Dashboard</a>
      </div>
      </div>
      <!-- Admin section: list of enrolled users -->
      <div id="adminUsersSection" style="margin-top:2rem; display:none;">
        <h3>Enrolled Users</h3>
        <table class="table" id="adminUsersTable">
          <thead>
            <tr><th>ID</th><th>Name</th><th>Email</th><th>Actions</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
<script>
  const userId = localStorage.getItem('userId');
  const welcomeNameEl = document.getElementById('welcomeName');
  const navPicEl = document.getElementById('navProfilePic');
  if (!userId) {
    window.location.href = 'index.html';
  }
  // Logout functionality
  document.getElementById('logoutBtn').addEventListener('click', () => {
    localStorage.removeItem('userId');
    localStorage.removeItem('userName');
    localStorage.removeItem('profilePicture');
    window.location.href = 'index.html';
  });
  // Update nav from localStorage or fetch
  function updateNav() {
    const name = localStorage.getItem('userName');
    if (name) welcomeNameEl.textContent = `Hello, ${name}!`;
    const pic = localStorage.getItem('profilePicture');
    if (pic) {
      navPicEl.src = pic;
      navPicEl.style.display = 'block';
    } else {
      navPicEl.style.display = 'none';
    }
  }
  updateNav();
  // Get course id from query string
  const params = new URLSearchParams(window.location.search);
  const courseId = parseInt(params.get('id'), 10);
  if (!courseId) {
    document.getElementById('courseTitle').textContent = 'Course Not Found';
  } else {
    loadCourse();
  }
  async function loadCourse() {
    try {
      const [courseRes, userCoursesRes] = await Promise.all([
        fetch(`/api/courses/${courseId}`),
        fetch(`/api/user/${userId}/courses`)
      ]);
      const course = await courseRes.json();
      const userCourses = await userCoursesRes.json();
      if (!courseRes.ok) throw new Error(course.error || 'Course not found');
      document.getElementById('courseTitle').textContent = course.title;
      document.getElementById('courseDescription').textContent = course.description || '';
      // Render course image if exists
      const imgContainer = document.getElementById('courseImageContainer');
      if (imgContainer) {
        imgContainer.innerHTML = '';
        if (course.image) {
          const img = document.createElement('img');
          img.src = course.image;
          img.alt = course.title;
          img.style.width = '100%';
          img.style.height = '200px';
          img.style.objectFit = 'cover';
          img.style.borderRadius = '4px';
          img.style.marginBottom = '1rem';
          imgContainer.appendChild(img);
        }
      }
      // Render course content as paragraphs and modules list
      const contentEl = document.getElementById('courseContent');
      const moduleListEl = document.getElementById('moduleList');
      contentEl.innerHTML = '';
      moduleListEl.innerHTML = '';
      if (course.content) {
        // Split content by double newline to separate intro and modules
        const parts = course.content.split(/\n\n+/);
        // First part as introduction text
        const intro = parts.shift();
        if (intro) {
          const p = document.createElement('p');
          p.textContent = intro;
          contentEl.appendChild(p);
        }
        // Remaining parts as modules
        if (parts.length > 0) {
          parts.forEach((mod, index) => {
            const li = document.createElement('li');
            li.className = 'list-group-item';
            li.innerHTML = `<strong>Module ${index + 1}:</strong> ${mod.trim()}`;
            moduleListEl.appendChild(li);
          });
        }
      }
      const uc = userCourses.find(c => c.id === course.id) || { progress: 0 };
      updateProgressBar(uc.progress);
      document.getElementById('increaseProgressBtn').onclick = () => markProgress(uc.progress);
      // If current user is admin (ID 1), load enrolled users list
      if (parseInt(userId, 10) === 1) {
        loadEnrolledUsers();
      }
    } catch (err) {
      console.error(err);
    }
  }
  function updateProgressBar(progress) {
    const bar = document.getElementById('progressBar');
    bar.style.width = `${progress}%`;
    bar.textContent = `${progress}%`;
  }
  async function markProgress(current) {
    const newProgress = Math.min(100, current + 10);
    try {
      const res = await fetch(`/api/user/${userId}/course/${courseId}/progress`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ progress: newProgress })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Failed to update progress');
      updateProgressBar(newProgress);
    } catch (err) {
      console.error(err);
    }
  }

  // Load list of users enrolled in this course (admin view)
  async function loadEnrolledUsers() {
    const section = document.getElementById('adminUsersSection');
    const tbody = document.querySelector('#adminUsersTable tbody');
    try {
      const res = await fetch(`/api/courses/${courseId}/users`);
      const users = await res.json();
      section.style.display = 'block';
      tbody.innerHTML = '';
      users.forEach(u => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${u.id}</td>
          <td><a href="admin-user.html?id=${u.id}" style="color:#007bff;text-decoration:none;">${u.name}</a></td>
          <td>${u.email}</td>
          <td><button class="btn btn-danger" data-user-id="${u.id}">Remove</button></td>`;
        tbody.appendChild(tr);
      });
      // Attach event listeners to remove buttons
      tbody.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const uid = parseInt(e.target.getAttribute('data-user-id'), 10);
          removeUserFromCourse(uid);
        });
      });
    } catch (err) {
      console.error(err);
    }
  }
  // Remove a user from this course (admin)
  async function removeUserFromCourse(uid) {
    if (!confirm('Remove this user from the course?')) return;
    try {
      const res = await fetch(`/api/admin/users/${uid}/courses/${courseId}`, { method: 'DELETE' });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Failed to remove user from course');
      // reload list
      loadEnrolledUsers();
    } catch (err) {
      alert(err.message);
    }
  }
</script>
</body>
</html>