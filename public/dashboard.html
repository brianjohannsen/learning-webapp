<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Learning App</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-DZ6AFxxVa1JJ7XOvFHagiJYagFM3kG9AmZUCr+v++uWfmxs9yL4wqhNJJTymehLd" crossorigin="anonymous">
</head>
<body class="bg-light">
  <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom shadow-sm">
    <div class="container-fluid">
      <a class="navbar-brand fw-bold" href="#">Learning App</a>
      <div class="d-flex ms-auto">
        <span id="welcomeName" class="navbar-text me-3"></span>
        <button class="btn btn-outline-danger btn-sm" id="logoutBtn">Logout</button>
      </div>
    </div>
  </nav>
  <div class="container mt-4">
    <h2>My Courses</h2>
    <div id="coursesContainer" class="row row-cols-1 row-cols-md-2 g-4 mt-2"></div>
  </div>
  <script>
    // Check authentication on page load
    const userId = localStorage.getItem('userId');
    const userName = localStorage.getItem('userName');
    const welcomeNameEl = document.getElementById('welcomeName');
    if (!userId) {
      // If not logged in, redirect to login
      window.location.href = 'index.html';
    } else {
      welcomeNameEl.textContent = `Hello, ${userName}!`;
      loadCourses();
    }

    // Logout button clears localStorage and redirects to login
    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('userId');
      localStorage.removeItem('userName');
      window.location.href = 'index.html';
    });

    // Fetch courses from server and render them
    async function loadCourses() {
      try {
        const res = await fetch(`/api/user/${userId}/courses`);
        const courses = await res.json();
        const container = document.getElementById('coursesContainer');
        container.innerHTML = '';
        courses.forEach(course => {
          const col = document.createElement('div');
          col.className = 'col';
          col.innerHTML = `
            <div class="card h-100 shadow-sm">
              <div class="card-body d-flex flex-column">
                <h5 class="card-title mb-3">${course.title}</h5>
                <div class="progress mb-3" style="height: 20px;">
                  <div class="progress-bar" role="progressbar" style="width: ${course.progress}%" aria-valuenow="${course.progress}" aria-valuemin="0" aria-valuemax="100">${course.progress}%</div>
                </div>
                <button class="btn btn-primary mt-auto" onclick="updateProgress(${course.id}, ${course.progress})">Mark Progress +10%</button>
              </div>
            </div>
          `;
          container.appendChild(col);
        });
      } catch (err) {
        console.error('Failed to load courses:', err);
      }
    }

    // Update course progress by 10% increments
    async function updateProgress(courseId, current) {
      const newProgress = Math.min(100, current + 10);
      try {
        const res = await fetch(`/api/user/${userId}/course/${courseId}/progress`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ progress: newProgress })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed to update progress');
        // Reload courses to reflect updated progress
        loadCourses();
      } catch (err) {
        console.error(err);
      }
    }
  </script>
</body>
</html>
