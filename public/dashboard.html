<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Learning App</title>
  <!-- Custom styles -->
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <nav class="navbar">
    <a href="#" class="brand">Learning App</a>
    <div class="nav-actions">
      <img id="navProfilePic" src="" alt="Profile" class="profile-pic" style="display:none;">
      <span id="welcomeName"></span>
      <a href="profile.html" class="btn btn-secondary">Profile</a>
      <a href="admin.html" id="adminLink" class="btn btn-secondary" style="display:none;">Admin</a>
      <button class="btn btn-danger" id="logoutBtn">Logout</button>
    </div>
  </nav>
  <div class="container">
    <!-- Points and badges display -->
    <div id="pointsBadges" style="margin-bottom: 1rem;"></div>
    <h2 style="margin-bottom: 1rem;">Courses</h2>
    <!-- Container for all courses -->
    <div id="coursesContainer" class="grid grid-2"></div>
  </div>
  <script>
    // Check authentication on page load
    const userId = localStorage.getItem('userId');
    const welcomeNameEl = document.getElementById('welcomeName');
    const navPicEl = document.getElementById('navProfilePic');
    if (!userId) {
      // If not logged in, redirect to login
      window.location.href = 'index.html';
    } else {
      // Load user details to update name and profile picture
      loadUserDetails();
      loadCourses();
    }

    // Logout button clears localStorage and redirects to login
    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('userId');
      localStorage.removeItem('userName');
      localStorage.removeItem('profilePicture');
      window.location.href = 'index.html';
    });

    // Load user details (name, picture) and update nav
    async function loadUserDetails() {
      try {
        const res = await fetch(`/api/user/${userId}`);
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed to load user');
        // Update email as name (we only store email)
        welcomeNameEl.textContent = `Hello, ${data.email}!`;
        localStorage.setItem('userName', data.email);
        // Profile pictures are not stored in the PG version; always use default
        navPicEl.src = 'default_profile.png';
        navPicEl.style.display = 'block';
        // If current user is admin (id === 1), show admin link
        const adminLinkEl = document.getElementById('adminLink');
        if (parseInt(userId) === 1 && adminLinkEl) {
          adminLinkEl.style.display = 'inline-block';
        }
        // Clear points/badges since they are not implemented in PG version
        const pbEl = document.getElementById('pointsBadges');
        pbEl.innerHTML = '';
      } catch (err) {
        console.error(err);
      }
    }
    // Fetch courses from server and render them with user progress
    async function loadCourses() {
      try {
        const res = await fetch('/api/courses');
        const courses = await res.json();
        const container = document.getElementById('coursesContainer');
        container.innerHTML = '';
        courses.forEach(course => {
          const div = document.createElement('div');
          // Display course image or placeholder
          let imgHtml;
          if (course.image) {
            imgHtml = `<img src="${course.image}" alt="${course.title}">`;
          } else {
            imgHtml = `<img src="default_course.png" alt="${course.title}">`;
          }
          div.innerHTML = `
            <div class="card course-card" style="display:flex; flex-direction:column; height:100%;">
              ${imgHtml}
              <h3 style="margin-bottom:0.5rem;">${course.title}</h3>
              <p style="flex-grow:1;">${course.description || ''}</p>
              <div style="margin-top:auto;">
                <a href="levels.html?id=${course.id}" class="btn btn-primary" style="width:100%;">Open</a>
              </div>
            </div>
          `;
          container.appendChild(div);
        });
      } catch (err) {
        console.error('Failed to load courses:', err);
      }
    }

    // Progress and enroll features are not implemented in the PG version
  </script>
</body>
</html>