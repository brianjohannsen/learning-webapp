<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Learning App</title>
  <!-- Custom styles -->
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <nav class="navbar">
    <a href="#" class="brand">Learning App</a>
    <div class="nav-actions">
      <img id="navProfilePic" src="" alt="Profile" class="profile-pic" style="display:none;">
      <span id="welcomeName"></span>
      <a href="profile.html" class="btn btn-secondary">Profile</a>
      <a href="admin.html" id="adminLink" class="btn btn-secondary" style="display:none;">Admin</a>
      <button class="btn btn-danger" id="logoutBtn">Logout</button>
    </div>
  </nav>
  <div class="container">
    <!-- Points and badges display -->
    <div id="pointsBadges" style="margin-bottom: 1rem;"></div>
    <h2 style="margin-bottom: 1rem;">My Courses</h2>
    <div id="coursesContainer" class="grid grid-2"></div>
    <h2 style="margin: 2rem 0 1rem;">Available Courses</h2>
    <div id="availableCoursesContainer" class="grid grid-2"></div>
  </div>
  <script>
    // Check authentication on page load
    const userId = localStorage.getItem('userId');
    const welcomeNameEl = document.getElementById('welcomeName');
    const navPicEl = document.getElementById('navProfilePic');
    if (!userId) {
      // If not logged in, redirect to login
      window.location.href = 'index.html';
    } else {
      // Load user details to update name and profile picture
      loadUserDetails();
      loadCourses();
    }

    // Logout button clears localStorage and redirects to login
    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('userId');
      localStorage.removeItem('userName');
      localStorage.removeItem('profilePicture');
      window.location.href = 'index.html';
    });

    // Load user details (name, picture) and update nav
    async function loadUserDetails() {
      try {
        const res = await fetch(`/api/user/${userId}`);
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed to load user');
        // Update name and profile picture
        welcomeNameEl.textContent = `Hello, ${data.name}!`;
        localStorage.setItem('userName', data.name);
        if (data.profilePicture) {
          navPicEl.src = data.profilePicture;
          navPicEl.style.display = 'block';
          localStorage.setItem('profilePicture', data.profilePicture);
        } else {
          // Use default placeholder image when no profile picture is set
          navPicEl.src = 'default_profile.png';
          navPicEl.style.display = 'block';
          localStorage.removeItem('profilePicture');
        }
        // If current user is admin (id === 1), show admin link
        const adminLinkEl = document.getElementById('adminLink');
        if (parseInt(userId) === 1 && adminLinkEl) {
          adminLinkEl.style.display = 'inline-block';
        }
        // Show points and badges
        const pbEl = document.getElementById('pointsBadges');
        let badgesHtml = '';
        if (Array.isArray(data.badges) && data.badges.length > 0) {
          badgesHtml = data.badges.map(b => `<span style="display:inline-block;margin-right:0.5rem;padding:0.25rem 0.5rem;border-radius:12px;background-color:#f0ad4e;color:#fff;font-size:0.75rem;">${b}</span>`).join(' ');
        }
        pbEl.innerHTML = `<strong>Points:</strong> ${data.points || 0} ${badgesHtml ? ' &nbsp; <strong>Badges:</strong> ' + badgesHtml : ''}`;
      } catch (err) {
        console.error(err);
      }
    }
    // Fetch courses from server and render them with user progress
    async function loadCourses() {
      try {
        const [coursesRes, userCoursesRes] = await Promise.all([
          fetch('/api/courses'),
          fetch(`/api/user/${userId}/courses`)
        ]);
        const courses = await coursesRes.json();
        const userCourses = await userCoursesRes.json();
        const courseMap = new Map(courses.map(c => [c.id, c]));
        const enrolledIds = new Set(userCourses.map(uc => uc.id));
        const coursesContainer = document.getElementById('coursesContainer');
        const availableContainer = document.getElementById('availableCoursesContainer');
        coursesContainer.innerHTML = '';
        availableContainer.innerHTML = '';
        // Render enrolled courses
        userCourses.forEach(uc => {
          const course = courseMap.get(uc.id);
          if (!course) return;
          const progress = uc.progress;
          const div = document.createElement('div');
          let imgHtml;
          if (course.image) {
            imgHtml = `<img src="${course.image}" alt="${course.title}">`;
          } else {
            imgHtml = `<img src="default_course.png" alt="${course.title}">`;
          }
          div.innerHTML = `
            <div class="card course-card" style="display: flex; flex-direction: column; height: 100%;">
              ${imgHtml}
              <h3 style="margin-bottom: 0.5rem;">${course.title}</h3>
              <div class="progress-container" style="margin-bottom: 1rem;">
                <div class="progress-bar" role="progressbar" style="width: ${progress}%">${progress}%</div>
              </div>
              <div style="margin-top: auto; display: flex; gap: 0.5rem;">
                <button class="btn btn-primary" style="flex:1;" onclick="updateProgress(${course.id}, ${progress})">Mark Progress +10%</button>
                <a href="levels.html?id=${course.id}" class="btn btn-outline" style="flex:1;">Open</a>
              </div>
            </div>
          `;
          coursesContainer.appendChild(div);
        });
        // Render available courses not enrolled
        courses.forEach(course => {
          if (enrolledIds.has(course.id)) return;
          const div = document.createElement('div');
          let imgHtml;
          if (course.image) {
            imgHtml = `<img src="${course.image}" alt="${course.title}">`;
          } else {
            imgHtml = `<img src="default_course.png" alt="${course.title}">`;
          }
          div.innerHTML = `
            <div class="card course-card" style="display: flex; flex-direction: column; height: 100%;">
              ${imgHtml}
              <h3 style="margin-bottom: 0.5rem;">${course.title}</h3>
              <p style="flex-grow:1;">${course.description || ''}</p>
              <div style="margin-top: auto; display: flex; gap: 0.5rem;">
                <button class="btn btn-primary" style="flex:1;" onclick="enroll(${course.id})">Enroll</button>
                <a href="levels.html?id=${course.id}" class="btn btn-outline" style="flex:1;">Open</a>
              </div>
            </div>
          `;
          availableContainer.appendChild(div);
        });
      } catch (err) {
        console.error('Failed to load courses:', err);
      }
    }

    // Update course progress by 10% increments
    async function updateProgress(courseId, current) {
      const newProgress = Math.min(100, current + 10);
      try {
        const res = await fetch(`/api/user/${userId}/course/${courseId}/progress`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ progress: newProgress })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed to update progress');
        // Reload courses to reflect updated progress
        loadCourses();
      } catch (err) {
        console.error(err);
      }
    }

    // Enroll user in a course
    async function enroll(courseId) {
      try {
        const res = await fetch(`/api/user/${userId}/courses/${courseId}/enroll`, { method: 'POST' });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed to enroll');
        // Reload courses to update lists
        loadCourses();
      } catch (err) {
        console.error(err);
        alert(err.message);
      }
    }
  </script>
</body>
</html>